


<!DOCTYPE html>
<html class="noios">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Lagom - Persistent Entity</title>
        <meta name="description" content="Lagom">
        
            <link rel="canonical" href="http://www.lagomframework.com/documentation/1.2.x/java/PersistentEntity.html"/>
        
        <meta name="viewport" content="width=device-width,maximum-scale=1"/>
        <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700" rel="stylesheet" type="text/css"/>
        <link rel="stylesheet" href="/all-styles-concat.css" type="text/css">
         
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css" />
    

    </head>
    <body>
        <div class="off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper>
                <div class="off-canvas position-left" id="offCanvasLeft" data-off-canvas >
                    <nav>
                        <button class="close-button" aria-label="Close menu" type="button" data-close>
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <a href="/download.html">Download</a>
                        

<h3>Documentation</h3>
<ul>
    <li><a href="/documentation/1.2.x/java/Installation.html">Installing</a></li>
    <li><a href="/documentation/1.2.x/java/GettingStarted.html">Getting started</a></li>
    <li><a href="/documentation/1.2.x/java/Home.html">Full documentation</a></li>
    <li><a href="/blog">Blog</a></li>
</ul>
<h3>Find help</h3>
<ul>
    <li><a href="https://gitter.im/lagom/lagom">Gitter channel</a></li>
    <li><a href="https://stackoverflow.com/questions/tagged/lagom">Stack overflow</a></li>
    <li><a href="https://www.lightbend.com/services/expert-support">Professional support</a></li>
</ul>
<h3>Contribute</h3>
<ul>
    <li><a href="/get-involved.html">Get involved</a></li>
    <li><a href="/conduct.html">Code of conduct</a></li>
    <li><a href="/community-process.html">Community process</a></li>
    <li><a href="/contributing.html">Contributor guidelines</a></li>
</ul>

                    </nav>
                </div>
                <div class="off-canvas-content" data-off-canvas-content>
                    <header class="navbar show-for-medium">
                        <div class="row">
                            <div class="small-12 columns">
                                <button class="menu-icon hide-for-medium" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                <a class="logo" href="/"><svg id="Lagom_Full_Color" class="svg-logo svg-logo-lagom-full-color" data-name="Lagom Full Color" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 752 192"><title>logom</title><g id="Lagom"><path d="M291.58,31.79h19.83v87.91c0,8.1,2.64,11.57,9.91,11.57a21.11,21.11,0,0,0,5.95-.66V148.3a35.63,35.63,0,0,1-9.42,1c-17.52,0-26.28-8.92-26.28-26.94V31.79Z" fill="#652b7c"/><path d="M398.34,75.75V63.69h19.83v58.17c0,7.11,1.65,9.75,6.11,9.75a41.28,41.28,0,0,0,4.13-.33v16a28.65,28.65,0,0,1-9.75,1.32c-4.79,0-8.59-.83-11.57-2.64a15.33,15.33,0,0,1-6.78-10.08C394.53,144.66,385,149,371.73,149A39.58,39.58,0,0,1,342,136.4c-7.93-8.43-11.9-18.67-11.9-31.07s4-22.64,11.9-30.9a39.58,39.58,0,0,1,29.75-12.56C385.12,61.87,395.2,67.82,398.34,75.75Zm-5.95,47.76a24.29,24.29,0,0,0,7.44-18.18,24.29,24.29,0,0,0-7.44-18.18,24.68,24.68,0,0,0-18-7.27,23.93,23.93,0,0,0-17.68,7.27c-4.63,4.79-6.94,10.91-6.94,18.18s2.31,13.39,6.94,18.18a23.93,23.93,0,0,0,17.68,7.27A24.68,24.68,0,0,0,392.39,123.51Z" fill="#652b7c"/><path d="M495.67,63.69H515.5v69.41c0,20-2.81,32.23-14,41-7.93,6.11-17.68,9.25-29.42,9.25-15.53,0-28.92-4-40.32-12.06l9.59-14.71a50.47,50.47,0,0,0,28.59,9.09q11.65,0,18.34-5c5.29-3.8,7.93-10.91,7.93-21.15v-4.13c-4,7.11-13.88,12.23-27.1,12.23a40.53,40.53,0,0,1-29.75-12.23c-7.93-8.1-11.9-18.34-11.9-30.41s4-22.31,12.06-30.57a39.23,39.23,0,0,1,29.58-12.56c13.72,0,23.8,5.78,26.61,13.88V63.69ZM489.72,123a24.19,24.19,0,0,0,7.44-18,23.82,23.82,0,0,0-7.44-17.85,24.68,24.68,0,0,0-18-7.27A23.93,23.93,0,0,0,454,87.15,24.69,24.69,0,0,0,447.09,105,25.08,25.08,0,0,0,454,123a23.79,23.79,0,0,0,17.68,7.11C478.81,130.12,484.93,127.81,489.72,123Z" fill="#652b7c"/><path d="M522.44,105.33a42.05,42.05,0,0,1,13.22-31.4c8.76-8.43,19.5-12.72,32.22-12.72s23.47,4.3,32.23,12.72a42.05,42.05,0,0,1,13.22,31.4,42.05,42.05,0,0,1-13.22,31.4c-8.76,8.43-19.5,12.72-32.23,12.72s-23.47-4.3-32.22-12.72A42.05,42.05,0,0,1,522.44,105.33ZM586.23,124a25.67,25.67,0,0,0,7.44-18.67,25,25,0,0,0-7.44-18.51,26.13,26.13,0,0,0-36.85,0,25.56,25.56,0,0,0-7.27,18.51A26.22,26.22,0,0,0,549.38,124,26.54,26.54,0,0,0,586.23,124Z" fill="#652b7c"/><path d="M620.6,147V63.69h19.67v11.9C643.74,67.49,652,62,662.58,62,674,62,681.91,66.83,686,76.58,690.84,66.83,699.76,62,712.81,62c18,0,28.42,12.72,28.42,33.38v26.28c0,6.44,1.16,8.76,5.62,8.76a14.56,14.56,0,0,0,2.81-.33v16.69a28.37,28.37,0,0,1-8.59,1c-13.05,0-19.5-7.27-19.5-21.81V98.23c0-11.4-5.29-18.51-14.54-18.51s-16,8.1-16,19.33V147H671.34V98.23c0-11.4-5.45-18.51-14.87-18.51-9.25,0-16.2,8.1-16.2,19.33V147H620.6Z" fill="#652b7c"/></g><g id="Icon"><path d="M261,84l-70,34,70,34S260.78,84.27,261,84Z" fill="#652b7c"/><polygon points="121 152 191 118 121 84 121 152" fill="#652b7c"/><path d="M191,118l70,34c-0.27,0-41.76,25-60.63,36.24a17.64,17.64,0,0,1-18,0C163.47,177,121,152,121,152Z" fill="#421540"/><path d="M200.23,47.65C219.09,58.88,261,84,261,84l-70,34L121,84c0.27,0,42.31-25.12,61.18-36.36A17.64,17.64,0,0,1,200.23,47.65Z" fill="#bf97c6"/><path d="M145,20.58l-35,17,35,17S144.89,20.72,145,20.58Z" fill="#652b7c"/><polygon points="75 54.58 110 37.58 75 20.58 75 54.58" fill="#652b7c"/><path d="M110,37.58l35,17c-0.14,0-20.88,12.5-30.31,18.12a8.82,8.82,0,0,1-9,0C96.23,67.08,75,54.58,75,54.58Z" fill="#421540"/><path d="M114.61,2.4C124,8,145,20.58,145,20.58l-35,17-35-17C75.14,20.59,96.16,8,105.59,2.4A8.82,8.82,0,0,1,114.61,2.4Z" fill="#bf97c6"/><path d="M101,91L51,115.54l50,24.53S100.84,91.21,101,91Z" fill="#652b7c"/><polygon points="1 140.07 51 115.54 1 91.02 1 140.07" fill="#652b7c"/><path d="M51,115.54l50,24.53c-0.19,0-29.83,18-43.3,26.14a12.5,12.5,0,0,1-12.89,0C31.34,158.1,1,140.07,1,140.07Z" fill="#421540"/><path d="M57.59,64.79C71.06,72.9,101,91,101,91L51,115.54,1,91C1.19,91,31.22,72.9,44.7,64.79A12.5,12.5,0,0,1,57.59,64.79Z" fill="#bf97c6"/></g></svg></a>
                                <nav class="sections show-for-medium">
                                    

<a href="/download.html">Download</a>
<a href="/documentation/1.2.x/java/Home.html">Documentation</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                </nav>
                            </div>
                        </div>
                    </header>
                    <div class="fw-wrapper flush social-bar">
                        <div class="row hide-for-medium">
                            <div class="small-12 columns">
                                <button class="menu-icon" type="button" data-open="offCanvasLeft" data-toggle="offCanvas"></button>
                                <a class="logo-for-small" href="/"><svg id="Lagom_Reverse" class="svg-logo svg-logo-lagom-reverse" data-name="Lagom Reverse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 752 192"><title>logom</title><g id="Lagom"><path d="M291.58,31.79h19.83v87.91c0,8.1,2.64,11.57,9.91,11.57a21.11,21.11,0,0,0,5.95-.66V148.3a35.63,35.63,0,0,1-9.42,1c-17.52,0-26.28-8.92-26.28-26.94V31.79Z" fill="#fff"/><path d="M398.34,75.75V63.69h19.83v58.17c0,7.11,1.65,9.75,6.11,9.75a41.28,41.28,0,0,0,4.13-.33v16a28.65,28.65,0,0,1-9.75,1.32c-4.79,0-8.59-.83-11.57-2.64a15.33,15.33,0,0,1-6.78-10.08C394.53,144.66,385,149,371.73,149A39.58,39.58,0,0,1,342,136.4c-7.93-8.43-11.9-18.67-11.9-31.07s4-22.64,11.9-30.9a39.58,39.58,0,0,1,29.75-12.56C385.12,61.87,395.2,67.82,398.34,75.75Zm-5.95,47.76a24.29,24.29,0,0,0,7.44-18.18,24.29,24.29,0,0,0-7.44-18.18,24.68,24.68,0,0,0-18-7.27,23.93,23.93,0,0,0-17.68,7.27c-4.63,4.79-6.94,10.91-6.94,18.18s2.31,13.39,6.94,18.18a23.93,23.93,0,0,0,17.68,7.27A24.68,24.68,0,0,0,392.39,123.51Z" fill="#fff"/><path d="M495.67,63.69H515.5v69.41c0,20-2.81,32.23-14,41-7.93,6.11-17.68,9.25-29.42,9.25-15.53,0-28.92-4-40.32-12.06l9.59-14.71a50.47,50.47,0,0,0,28.59,9.09q11.65,0,18.34-5c5.29-3.8,7.93-10.91,7.93-21.15v-4.13c-4,7.11-13.88,12.23-27.1,12.23a40.53,40.53,0,0,1-29.75-12.23c-7.93-8.1-11.9-18.34-11.9-30.41s4-22.31,12.06-30.57a39.23,39.23,0,0,1,29.58-12.56c13.72,0,23.8,5.78,26.61,13.88V63.69ZM489.72,123a24.19,24.19,0,0,0,7.44-18,23.82,23.82,0,0,0-7.44-17.85,24.68,24.68,0,0,0-18-7.27A23.93,23.93,0,0,0,454,87.15,24.69,24.69,0,0,0,447.09,105,25.08,25.08,0,0,0,454,123a23.79,23.79,0,0,0,17.68,7.11C478.81,130.12,484.93,127.81,489.72,123Z" fill="#fff"/><path d="M522.44,105.33a42.05,42.05,0,0,1,13.22-31.4c8.76-8.43,19.5-12.72,32.22-12.72s23.47,4.3,32.23,12.72a42.05,42.05,0,0,1,13.22,31.4,42.05,42.05,0,0,1-13.22,31.4c-8.76,8.43-19.5,12.72-32.23,12.72s-23.47-4.3-32.22-12.72A42.05,42.05,0,0,1,522.44,105.33ZM586.23,124a25.67,25.67,0,0,0,7.44-18.67,25,25,0,0,0-7.44-18.51,26.13,26.13,0,0,0-36.85,0,25.56,25.56,0,0,0-7.27,18.51A26.22,26.22,0,0,0,549.38,124,26.54,26.54,0,0,0,586.23,124Z" fill="#fff"/><path d="M620.6,147V63.69h19.67v11.9C643.74,67.49,652,62,662.58,62,674,62,681.91,66.83,686,76.58,690.84,66.83,699.76,62,712.81,62c18,0,28.42,12.72,28.42,33.38v26.28c0,6.44,1.16,8.76,5.62,8.76a14.56,14.56,0,0,0,2.81-.33v16.69a28.37,28.37,0,0,1-8.59,1c-13.05,0-19.5-7.27-19.5-21.81V98.23c0-11.4-5.29-18.51-14.54-18.51s-16,8.1-16,19.33V147H671.34V98.23c0-11.4-5.45-18.51-14.87-18.51-9.25,0-16.2,8.1-16.2,19.33V147H620.6Z" fill="#fff"/></g><g id="Icon"><g opacity="0.8"><path d="M261,84l-70,34,70,34S260.78,84.27,261,84Z" fill="#fff"/></g><g opacity="0.8"><polygon points="121 152 191 118 121 84 121 152" fill="#fff"/></g><path d="M191,118l70,34c-0.27,0-41.76,25-60.63,36.24a17.64,17.64,0,0,1-18,0C163.47,177,121,152,121,152Z" fill="#fff" opacity="0.6"/><path d="M200.23,47.65C219.09,58.88,261,84,261,84l-70,34L121,84c0.27,0,42.31-25.12,61.18-36.36A17.64,17.64,0,0,1,200.23,47.65Z" fill="#fff"/><g opacity="0.8"><path d="M145,20.58l-35,17,35,17S144.89,20.72,145,20.58Z" fill="#fff"/></g><g opacity="0.8"><polygon points="75 54.58 110 37.58 75 20.58 75 54.58" fill="#fff"/></g><path d="M110,37.58l35,17c-0.14,0-20.88,12.5-30.31,18.12a8.82,8.82,0,0,1-9,0C96.23,67.08,75,54.58,75,54.58Z" fill="#fff" opacity="0.6"/><path d="M114.61,2.4C124,8,145,20.58,145,20.58l-35,17-35-17C75.14,20.59,96.16,8,105.59,2.4A8.82,8.82,0,0,1,114.61,2.4Z" fill="#fff"/><g opacity="0.8"><path d="M101,91L51,115.54l50,24.53S100.84,91.21,101,91Z" fill="#fff"/></g><g opacity="0.8"><polygon points="1 140.07 51 115.54 1 91.02 1 140.07" fill="#fff"/></g><path d="M51,115.54l50,24.53c-0.19,0-29.83,18-43.3,26.14a12.5,12.5,0,0,1-12.89,0C31.34,158.1,1,140.07,1,140.07Z" fill="#fff" opacity="0.6"/><path d="M57.59,64.79C71.06,72.9,101,91,101,91L51,115.54,1,91C1.19,91,31.22,72.9,44.7,64.79A12.5,12.5,0,0,1,57.59,64.79Z" fill="#fff"/></g></svg></a>
                            </div>
                        </div>
                        <div class="row show-for-medium">
                            <div class="small-12 columns">
                                <!-- social icons -->
                                <a class="logo" href="/"><svg id="Lagom_Reverse" class="svg-logo svg-logo-lagom-reverse" data-name="Lagom Reverse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 752 192"><title>logom</title><g id="Lagom"><path d="M291.58,31.79h19.83v87.91c0,8.1,2.64,11.57,9.91,11.57a21.11,21.11,0,0,0,5.95-.66V148.3a35.63,35.63,0,0,1-9.42,1c-17.52,0-26.28-8.92-26.28-26.94V31.79Z" fill="#fff"/><path d="M398.34,75.75V63.69h19.83v58.17c0,7.11,1.65,9.75,6.11,9.75a41.28,41.28,0,0,0,4.13-.33v16a28.65,28.65,0,0,1-9.75,1.32c-4.79,0-8.59-.83-11.57-2.64a15.33,15.33,0,0,1-6.78-10.08C394.53,144.66,385,149,371.73,149A39.58,39.58,0,0,1,342,136.4c-7.93-8.43-11.9-18.67-11.9-31.07s4-22.64,11.9-30.9a39.58,39.58,0,0,1,29.75-12.56C385.12,61.87,395.2,67.82,398.34,75.75Zm-5.95,47.76a24.29,24.29,0,0,0,7.44-18.18,24.29,24.29,0,0,0-7.44-18.18,24.68,24.68,0,0,0-18-7.27,23.93,23.93,0,0,0-17.68,7.27c-4.63,4.79-6.94,10.91-6.94,18.18s2.31,13.39,6.94,18.18a23.93,23.93,0,0,0,17.68,7.27A24.68,24.68,0,0,0,392.39,123.51Z" fill="#fff"/><path d="M495.67,63.69H515.5v69.41c0,20-2.81,32.23-14,41-7.93,6.11-17.68,9.25-29.42,9.25-15.53,0-28.92-4-40.32-12.06l9.59-14.71a50.47,50.47,0,0,0,28.59,9.09q11.65,0,18.34-5c5.29-3.8,7.93-10.91,7.93-21.15v-4.13c-4,7.11-13.88,12.23-27.1,12.23a40.53,40.53,0,0,1-29.75-12.23c-7.93-8.1-11.9-18.34-11.9-30.41s4-22.31,12.06-30.57a39.23,39.23,0,0,1,29.58-12.56c13.72,0,23.8,5.78,26.61,13.88V63.69ZM489.72,123a24.19,24.19,0,0,0,7.44-18,23.82,23.82,0,0,0-7.44-17.85,24.68,24.68,0,0,0-18-7.27A23.93,23.93,0,0,0,454,87.15,24.69,24.69,0,0,0,447.09,105,25.08,25.08,0,0,0,454,123a23.79,23.79,0,0,0,17.68,7.11C478.81,130.12,484.93,127.81,489.72,123Z" fill="#fff"/><path d="M522.44,105.33a42.05,42.05,0,0,1,13.22-31.4c8.76-8.43,19.5-12.72,32.22-12.72s23.47,4.3,32.23,12.72a42.05,42.05,0,0,1,13.22,31.4,42.05,42.05,0,0,1-13.22,31.4c-8.76,8.43-19.5,12.72-32.23,12.72s-23.47-4.3-32.22-12.72A42.05,42.05,0,0,1,522.44,105.33ZM586.23,124a25.67,25.67,0,0,0,7.44-18.67,25,25,0,0,0-7.44-18.51,26.13,26.13,0,0,0-36.85,0,25.56,25.56,0,0,0-7.27,18.51A26.22,26.22,0,0,0,549.38,124,26.54,26.54,0,0,0,586.23,124Z" fill="#fff"/><path d="M620.6,147V63.69h19.67v11.9C643.74,67.49,652,62,662.58,62,674,62,681.91,66.83,686,76.58,690.84,66.83,699.76,62,712.81,62c18,0,28.42,12.72,28.42,33.38v26.28c0,6.44,1.16,8.76,5.62,8.76a14.56,14.56,0,0,0,2.81-.33v16.69a28.37,28.37,0,0,1-8.59,1c-13.05,0-19.5-7.27-19.5-21.81V98.23c0-11.4-5.29-18.51-14.54-18.51s-16,8.1-16,19.33V147H671.34V98.23c0-11.4-5.45-18.51-14.87-18.51-9.25,0-16.2,8.1-16.2,19.33V147H620.6Z" fill="#fff"/></g><g id="Icon"><g opacity="0.8"><path d="M261,84l-70,34,70,34S260.78,84.27,261,84Z" fill="#fff"/></g><g opacity="0.8"><polygon points="121 152 191 118 121 84 121 152" fill="#fff"/></g><path d="M191,118l70,34c-0.27,0-41.76,25-60.63,36.24a17.64,17.64,0,0,1-18,0C163.47,177,121,152,121,152Z" fill="#fff" opacity="0.6"/><path d="M200.23,47.65C219.09,58.88,261,84,261,84l-70,34L121,84c0.27,0,42.31-25.12,61.18-36.36A17.64,17.64,0,0,1,200.23,47.65Z" fill="#fff"/><g opacity="0.8"><path d="M145,20.58l-35,17,35,17S144.89,20.72,145,20.58Z" fill="#fff"/></g><g opacity="0.8"><polygon points="75 54.58 110 37.58 75 20.58 75 54.58" fill="#fff"/></g><path d="M110,37.58l35,17c-0.14,0-20.88,12.5-30.31,18.12a8.82,8.82,0,0,1-9,0C96.23,67.08,75,54.58,75,54.58Z" fill="#fff" opacity="0.6"/><path d="M114.61,2.4C124,8,145,20.58,145,20.58l-35,17-35-17C75.14,20.59,96.16,8,105.59,2.4A8.82,8.82,0,0,1,114.61,2.4Z" fill="#fff"/><g opacity="0.8"><path d="M101,91L51,115.54l50,24.53S100.84,91.21,101,91Z" fill="#fff"/></g><g opacity="0.8"><polygon points="1 140.07 51 115.54 1 91.02 1 140.07" fill="#fff"/></g><path d="M51,115.54l50,24.53c-0.19,0-29.83,18-43.3,26.14a12.5,12.5,0,0,1-12.89,0C31.34,158.1,1,140.07,1,140.07Z" fill="#fff" opacity="0.6"/><path d="M57.59,64.79C71.06,72.9,101,91,101,91L51,115.54,1,91C1.19,91,31.22,72.9,44.7,64.79A12.5,12.5,0,0,1,57.59,64.79Z" fill="#fff"/></g></svg></a>
                                <nav class="social">
                                    <a href="//groups.google.com/forum/#!forum/lagom-framework"><span>Mailing list</span></a>
                                    <a href="//twitter.com/lagom"><span>Twitter</span></a>
                                    <a href="//github.com/lagom/lagom"><span>Github</span></a>
                                    <a href="//stackoverflow.com/questions/tagged/lagom"><span>Stackoverflow</span></a>
                                </nav>
                                <nav class="sections-scroll">
                                    

<a href="/download.html">Download</a>
<a href="/documentation/1.2.x/java/Home.html">Documentation</a>
<a href="/get-involved.html">Get Involved</a>
<a href="/blog/">Blog</a>

                                </nav>
                            </div>
                        </div>
                    </div>

                      
    <header class="fw-wrapper lgm-purple page-title">
        <div class="row">
            <div class="small-12 columns">
                <h1>Persistent Entity</h1>
            </div>
        </div>
    </header>

    <div class="fw-wrapper documentation-content">
        <div class="row">
            <div class="small-12 large-7 columns">
                
                    <nav class="breadcrumbs">
                        <a href="Home.html">Home</a>
                        
                            &raquo; <a href="ReferenceGuide.html">Lagom reference guide</a>
                        
                            &raquo; <a href="PersistentEntity.html">Writing persistent and clustered services</a>
                        
                    </nav>
                

                <article>
                <h1 id="Persistent-Entity"><a class="section-marker" href="#Persistent-Entity">§</a><a href="#persistent-entity" name="persistent-entity">Persistent Entity</a></h1>
<p><a href="ES_CQRS.html">Event Sourcing and CQRS</a> is a recommended introduction to this section.</p>
<p>A <code>PersistentEntity</code> has a stable entity identifier, with which it can be accessed from the service implementation or other places. The state of an entity is persistent (durable) using <a href="https://msdn.microsoft.com/en-us/library/jj591559.aspx">Event Sourcing</a>. We represent all state changes as events and those immutable facts are appended to an event log. To recreate the current state of an entity when it is started we replay these events.</p>
<p>A persistent entity corresponds to an <a href="http://martinfowler.com/bliki/DDD_Aggregate.html">Aggregate Root</a> in Domain-Driven Design terms. Each instance has a stable identifier and for a given id there will only be one instance of the entity. Lagom takes care of distributing those instances across the cluster of the service. If you know the identifier you can send messages, so called commands, to the entity.</p>
<p>The persistent entity is also a transaction boundary. Invariants can be maintained within one entity but not across several entities.</p>
<p>If you are familiar with <a href="https://en.wikipedia.org/wiki/Java_Persistence_API">JPA</a> it is worth noting that a <code>PersistentEntity</code> can be used for similar things as a JPA <code>@Entity</code> but several aspects are rather different. For example, a JPA <code>@Entity</code> is loaded from the database from wherever it is needed, i.e. there may be many Java object instances with the same entity identifier. In contrast, there is only one instance of <code>PersistentEntity</code> with a given identifier. With JPA you typically only store current state and the history of how the state was reached is not captured.</p>
<p>You interact with a <code>PersistentEntity</code> by sending command messages to it. Commands are processed sequentially, one at a time, for a specific entity instance. A command may result in state changes that are persisted as events, representing the effect of the command. The current state is not stored for every change, since it can be derived from the events. These events are only ever appended to storage, nothing is ever mutated, which allows for very high transaction rates and efficient replication.</p>
<p>The entities are automatically distributed across the nodes in the cluster of the service. Each entity runs only at one place, and messages can be sent to the entity without requiring the sender to know the location of the entity. If a node is stopped the entities running on that node will be started on another node when a message is sent to it next time. When new nodes are added to the cluster some existing entities are rebalanced to the new nodes to spread the load.</p>
<p>An entity is kept alive, holding its current state in memory, as long as it is used. When it has not been used for a while it will automatically be passivated to free up resources.</p>
<p>When an entity is started it replays the stored events to restore the current state. This can be either the full history of changes or starting from a snapshot which will reduce recovery times.</p><h2 id="Choosing-a-database"><a class="section-marker" href="#Choosing-a-database">§</a><a href="#choosing-a-database" name="choosing-a-database">Choosing a database</a></h2>
<p>Lagom supports the following databases:</p>
<ul>
  <li><a href="https://cassandra.apache.org/">Cassandra</a></li>
  <li><a href="https://www.postgresql.org/">PostgreSQL</a></li>
  <li><a href="https://www.mysql.com/">MySQL</a></li>
  <li><a href="https://www.oracle.com/database/index.html">Oracle</a></li>
  <li><a href="http://www.h2database.com/">H2</a></li>
</ul>
<p>We recommend using Cassandra. Cassandra is a very scalable distributed database, and it is also flexible enough to support typical use cases of reactive services. In contrast to most relational databases, it natively supports sharding and replication, and is emerging as an industry standard open source NoSQL database.</p>
<p>Lagom also provides out of the box support for running Cassandra in a development environment - developers do not need to install, configure or manage Cassandra at all themselves when using Lagom, which makes for great developer velocity, and it means gone are the days where developers spend days setting up their development environment before they can start to be productive on a project.</p>
<p>For instructions on configuring your project to use Cassandra, see <a href="PersistentEntityCassandra.html">Using Cassandra for Persistent Entities</a>. If instead you want to use one of the relational databases listed above, see <a href="PersistentEntityRDBMS.html">Using a Relational Database for Persistent Entities</a> on how to configure your project.</p><h2 id="PersistentEntity-Stub"><a class="section-marker" href="#PersistentEntity-Stub">§</a><a href="#persistententity-stub" name="persistententity-stub">PersistentEntity Stub</a></h2>
<p>This is how a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/PersistentEntity.html">PersistentEntity</a> class looks like before filling in the implementation details:</p>
<pre class="prettyprint"><code class="language-java">import com.lightbend.lagom.javadsl.persistence.PersistentEntity;

public class Post1
  extends PersistentEntity&lt;BlogCommand, BlogEvent, BlogState&gt; {

  @Override
  public Behavior initialBehavior(Optional&lt;BlogState&gt; snapshotState) {
    BehaviorBuilder b = newBehaviorBuilder(
        snapshotState.orElse(BlogState.EMPTY));

    // TODO define command and event handlers

    return b.build();
  }

}</code></pre>
<p>The three type parameters of the extended <code>PersistentEntity</code> class define:</p>
<ul>
  <li><code>Command</code> - the super class/interface of the commands</li>
  <li><code>Event</code> - the super class/interface of the events</li>
  <li><code>State</code> - the class of the state</li>
</ul>
<p><code>initialBehavior</code> is an abstract method that your concrete subclass must implement. It returns the <code>Behavior</code> of the entity. Use <code>newBehaviorBuilder</code> to create a mutable builder for defining the behavior. The behavior consists of current state and functions to process incoming commands and persisted events as described in the following sections.</p><h2 id="Command-Handlers"><a class="section-marker" href="#Command-Handlers">§</a><a href="#command-handlers" name="command-handlers">Command Handlers</a></h2>
<p>The functions that process incoming commands are registered in the <code>Behavior</code> using <code>setCommandHandler</code> of the <code>BehaviorBuilder</code>.</p>
<pre class="prettyprint"><code class="language-java">// Command handlers are invoked for incoming messages (commands).
// A command handler must &quot;return&quot; the events to be persisted (if any).
b.setCommandHandler(AddPost.class, (AddPost cmd, CommandContext&lt;AddPostDone&gt; ctx) -&gt; {
  final PostAdded postAdded = new PostAdded(entityId(), cmd.getContent());
  return ctx.thenPersist(postAdded, (PostAdded evt) -&gt;
    // After persist is done additional side effects can be performed
    ctx.reply(new AddPostDone(entityId())));
});</code></pre>
<p>You should define one command handler for each command class that the entity can receive.</p>
<p>A command handler returns a <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/PersistentEntity.Persist.html">Persist</a> directive that defines what event or events, if any, to persist. Use the <code>thenPersist</code>, <code>thenPersistAll</code> or <code>done</code> methods of the context that is passed to the command handler function to create the <code>Persist</code> directive.</p>
<ul>
  <li><code>thenPersist</code> will persist one single event</li>
  <li><code>thenPersistAll</code> will persist several events atomically, i.e. all events<br/> are stored or none of them are stored if there is an error</li>
  <li><code>done</code> no events are to be persisted</li>
</ul>
<p>External side effects can be performed after successful persist in the <code>afterPersist</code> function. In the above example a reply is sent with the <code>ctx.reply</code> method.</p>
<p>The command can be validated before persisting state changes. Use <code>ctx.invalidCommand</code> or <code>ctx.commandFailed</code> to reject an invalid command.</p>
<pre class="prettyprint"><code class="language-java">b.setCommandHandler(AddPost.class, (AddPost cmd, CommandContext&lt;AddPostDone&gt; ctx) -&gt; {
  if (cmd.getContent().getTitle() == null || cmd.getContent().getTitle().equals(&quot;&quot;)) {
    ctx.invalidCommand(&quot;Title must be defined&quot;);
    return ctx.done();
  }</code></pre>
<p>A <code>PersistentEntity</code> may also process commands that do not change application state, such as query commands. Such command handlers are registered using <code>setReadOnlyCommandHandler</code> of the <code>BehaviorBuilder</code>. Replies are sent with the <code>reply</code> method of the context that is passed to the command handler function.</p>
<pre class="prettyprint"><code class="language-java">b.setReadOnlyCommandHandler(GetPost.class, (cmd, ctx) -&gt;
  ctx.reply(state().getContent().get()));</code></pre>
<p>The commands must be immutable to avoid concurrency issues that may occur from changing a command instance that has been sent.</p>
<p>The section <a href="Immutable.html">Immutable Objects</a> describes how to define immutable command classes. </p><h2 id="Event-Handlers"><a class="section-marker" href="#Event-Handlers">§</a><a href="#event-handlers" name="event-handlers">Event Handlers</a></h2>
<p>When an event has been persisted successfully the current state is updated by applying the event to the current state. The functions for updating the state are registered with the <code>setEventHandler</code> method of the <code>BehaviorBuilder</code>.</p>
<pre class="prettyprint"><code class="language-java">// Event handlers are used both when persisting new events
// and when replaying events.
b.setEventHandler(PostAdded.class, evt -&gt;
  new BlogState(Optional.of(evt.getContent()), false));</code></pre>
<p>You should define one event handler for each event class that the entity can persists.</p>
<p>The event handler returns the new state. The state must be immutable, so you return a new instance of the state. Current state can be accessed from the event handler with the <code>state</code> method of the <code>PersistentEntity</code>. The same event handlers are also used when the entity is started up to recover its state from the stored events.</p>
<p>The events must be immutable to avoid concurrency issues that may occur from changing an event instance that is about to be persisted.</p>
<p>The section <a href="Immutable.html">Immutable Objects</a> describes how to define immutable event classes.</p><h2 id="Replies"><a class="section-marker" href="#Replies">§</a><a href="#replies" name="replies">Replies</a></h2>
<p>Each command must define what type of message to use as reply to the command by implementing the <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/PersistentEntity.ReplyType.html">PersistentEntity.ReplyType</a> interface.</p>
<pre class="prettyprint"><code class="language-java">final class AddPost implements BlogCommand, PersistentEntity.ReplyType&lt;AddPostDone&gt; {
  private final PostContent content;

  @JsonCreator
  public AddPost(PostContent content) {
    this.content = content;
  }

  public PostContent getContent() {
    return content;
  }

  @Override
  public boolean equals(Object o) {
    if (this == o) return true;
    if (o == null || getClass() != o.getClass()) return false;

    AddPost addPost = (AddPost) o;

    return content.equals(addPost.content);

  }

  @Override
  public int hashCode() {
    return content.hashCode();
  }
}</code></pre>
<p>You send the reply message using the <code>reply</code> method of the context that is passed to the command handler function. </p>
<p>Typically the reply will be an acknowledgment that the entity processed the command successfully, i.e. you send it after persist.</p>
<pre class="prettyprint"><code class="language-java">b.setCommandHandler(ChangeBody.class,
    (cmd, ctx) -&gt; ctx.thenPersist(new BodyChanged(entityId(), cmd.getBody()), evt -&gt;
      ctx.reply(Done.getInstance())));</code></pre>
<p>For convenience you may use the <code>akka.Done</code> as acknowledgment message.</p>
<p>It can also be a reply to a read-only query command.</p>
<pre class="prettyprint"><code class="language-java">b.setReadOnlyCommandHandler(GetPost.class, (cmd, ctx) -&gt;
  ctx.reply(state().getContent().get()));</code></pre>
<p>You can use <code>ctx.invalidCommand</code> to reject an invalid command, which will fail the <code>CompletionStage</code> with <code>PersistentEntity.InvalidCommandException</code> on the sender side.</p>
<p>You can send a negative acknowledgment with <code>ctx.commandFailed</code>, which will fail the <code>CompletionStage</code> on the sender side with the given exception.</p>
<p>If persisting the events fails a negative acknowledgment is automatically sent, which will fail the <code>CompletionStage</code> on the sender side with <code>PersistentEntity.PersistException</code>.</p>
<p>If the <code>PersistentEntity</code> receives a command for which there is no registered command handler a negative acknowledgment is automatically sent, which will fail the the <code>CompletionStage</code> on the sender side with <code>PersistentEntity.UnhandledCommandException</code>.</p>
<p>If you don&rsquo;t reply to a command the <code>CompletionStage</code> on the sender side will be completed with a <code>akka.pattern.AskTimeoutException</code> after a timeout.</p><h2 id="Changing-Behavior"><a class="section-marker" href="#Changing-Behavior">§</a><a href="#changing-behavior" name="changing-behavior">Changing Behavior</a></h2>
<p>The event handlers are typically only updating the state, but they may also change the behavior of the entity in the sense that new functions for processing commands and events may be defined. This is useful when implementing finite state machine (FSM) like entities. Event handlers that change the behavior are registered with the <code>setEventHandlerChangingBehavior</code> of the <code>BehaviorBuilder</code>. Such an event handler returns the new <code>Behavior</code> instead of just returning the new state.</p>
<pre class="prettyprint"><code class="language-java">b.setEventHandlerChangingBehavior(PostAdded.class, evt -&gt;
  becomePostAdded(new BlogState(Optional.of(evt.getContent()), false)));</code></pre>
<pre class="prettyprint"><code class="language-java">private Behavior becomePostAdded(BlogState newState) {
  BehaviorBuilder b = newBehaviorBuilder(newState);

  b.setReadOnlyCommandHandler(GetPost.class, (cmd, ctx) -&gt;
    ctx.reply(state().getContent().get()));

  b.setCommandHandler(ChangeBody.class,
      (cmd, ctx) -&gt; ctx.thenPersist(new BodyChanged(entityId(), cmd.getBody()), evt -&gt;
        ctx.reply(Done.getInstance())));

  b.setEventHandler(BodyChanged.class, evt -&gt; state().withBody(evt.getBody()));

  return b.build();
}</code></pre>
<p>In the above example we are creating a completely new <code>Behavior</code> with <code>newBehaviorBuilder</code>. It is also possible to start with current <code>Behavior</code> and modify it. You can access current behavior with the <code>behavior</code> method of the <code>PersistentEntity</code> and then use the <code>builder</code> method of the <code>Behavior</code>.</p><h2 id="Snapshots"><a class="section-marker" href="#Snapshots">§</a><a href="#snapshots" name="snapshots">Snapshots</a></h2>
<p>When the entity is started the state is recovered by replaying stored events. To reduce this recovery time the entity may start the recovery from a snapshot of the state and then only replaying the events that were stored after the snapshot.</p>
<p>Such snapshots are automatically saved after a configured number of persisted events. The snapshot if any is passed as a parameter to the <code>initialBehavior</code> method and you should use that state as the state of the returned <code>Behavior</code>.</p>
<p>One thing to keep in mind is that if you are using event handlers that change the behavior (<code>setEventHandlerChangingBehavior</code>) you must also restore corresponding <code>Behavior</code> from the snapshot state that is passed as a parameter to the <code>initialBehavior</code> method.</p>
<pre class="prettyprint"><code class="language-java">@Override
public Behavior initialBehavior(Optional&lt;BlogState&gt; snapshotState) {
  if (snapshotState.isPresent() &amp;&amp; !snapshotState.get().isEmpty()) {
    // behavior after snapshot must be restored by initialBehavior
    // if we have a non-empty BlogState we know that the initial
    // AddPost has been performed
    return becomePostAdded(snapshotState.get());
  } else {
    // behavior when no snapshot is used
    BehaviorBuilder b = newBehaviorBuilder(BlogState.EMPTY);

    // TODO define command and event handlers

    return b.build();
  }
}</code></pre>
<p>The state must be immutable to avoid concurrency issues that may occur from changing a state instance that is about to be saved as snapshot.</p>
<p>The section <a href="Immutable.html">Immutable Objects</a> describes how to define immutable state classes.</p><h2 id="Usage-from-Service-Implementation"><a class="section-marker" href="#Usage-from-Service-Implementation">§</a><a href="#usage-from-service-implementation" name="usage-from-service-implementation">Usage from Service Implementation</a></h2>
<p>To access an entity from a service implementation you first need to inject the <a href="api/index.html?com/lightbend/lagom/javadsl/persistence/PersistentEntityRegistry.html">PersistentEntityRegistry</a> and at startup (in the constructor) register the class that implements the <code>PersistentEntity</code>.</p>
<p>In the service method you retrieve a <code>PersistentEntityRef</code> for a given entity identifier from the registry. Then you can send the command to the entity using the <code>ask</code> method of the <code>PersistentEntityRef</code>. <code>ask</code> returns a <code>CompletionStage</code> with the reply message.</p>
<pre class="prettyprint"><code class="language-java">import com.lightbend.lagom.javadsl.persistence.PersistentEntityRef;

import javax.inject.Inject;
import com.lightbend.lagom.javadsl.persistence.PersistentEntityRegistry;
import com.lightbend.lagom.javadsl.api.*;

public class BlogServiceImpl implements BlogService {

  private final PersistentEntityRegistry persistentEntities;

  @Inject
  public BlogServiceImpl(PersistentEntityRegistry persistentEntities) {
    this.persistentEntities = persistentEntities;

    persistentEntities.register(Post.class);
  }

  @Override
  public ServiceCall&lt;BlogCommand.AddPost, String&gt; addPost(String id) {
    return request -&gt; {
      PersistentEntityRef&lt;BlogCommand&gt; ref =
        persistentEntities.refFor(Post.class, id);
      return ref.ask(request).thenApply(ack -&gt; &quot;OK&quot;);
    };
  }
}</code></pre>
<p>In this example we are using the command <code>AddPost</code> also as the request parameter of the service method, but you can of course use another type for the external API of the service.</p>
<p>The commands are sent as messages to the entity that may be running on a different node. If that node is not available due to network issues, JVM crash or similar the messages may be lost until the problem has been detected and the entities have been migrated to another node. In such situations the <code>ask</code> will time out and the <code>CompletionStage</code> will be completed with <code>akka.pattern.AskTimeoutException</code>.</p>
<p>Note that the <code>AskTimeoutException</code> is not a guarantee that the command was not processed. For example, the command might have been processed but the reply message was lost.</p><h2 id="Serialization"><a class="section-marker" href="#Serialization">§</a><a href="#serialization" name="serialization">Serialization</a></h2>
<p>JSON is the recommended format the persisted events and state. The <a href="Serialization.html">Serialization</a> section describes how to add Jackson serialization support to such classes and also how to evolve the classes, which is especially important for the persistent state and events, since you must be able to deserialize old objects that were stored.</p><h2 id="Unit-Testing"><a class="section-marker" href="#Unit-Testing">§</a><a href="#unit-testing" name="unit-testing">Unit Testing</a></h2>
<p>For unit testing of the entity you can use the <a href="api/index.html?com/lightbend/lagom/javadsl/testkit/PersistentEntityTestDriver.html">PersistentEntityTestDriver</a>, which will run the <code>PersistentEntity</code> without using a database. You can verify that it emits expected events and side-effects in response to incoming commands.</p>
<pre class="prettyprint"><code class="language-java">import static org.junit.Assert.assertEquals;

import java.util.Collections;
import java.util.Optional;
import com.lightbend.lagom.javadsl.persistence.PersistentEntity.InvalidCommandException;
import com.lightbend.lagom.javadsl.testkit.PersistentEntityTestDriver;
import com.lightbend.lagom.javadsl.testkit.PersistentEntityTestDriver.Outcome;
import org.junit.AfterClass;
import org.junit.BeforeClass;
import org.junit.Test;

import akka.Done;
import akka.actor.ActorSystem;
import akka.testkit.JavaTestKit;

public class PostTest {

  static ActorSystem system;

  @BeforeClass
  public static void setup() {
    system = ActorSystem.create();
  }

  @AfterClass
  public static void teardown() {
    JavaTestKit.shutdownActorSystem(system);
    system = null;
  }

  @Test
  public void testAddPost() {
    PersistentEntityTestDriver&lt;BlogCommand, BlogEvent, BlogState&gt; driver =
        new PersistentEntityTestDriver&lt;&gt;(system, new Post(), &quot;post-1&quot;);

    PostContent content = new PostContent(&quot;Title&quot;, &quot;Body&quot;);
    Outcome&lt;BlogEvent, BlogState&gt; outcome = driver.run(
        new AddPost(content));
    assertEquals(new PostAdded(&quot;post-1&quot;, content),
        outcome.events().get(0));
    assertEquals(1, outcome.events().size());
    assertEquals(false, outcome.state().isPublished());
    assertEquals(Optional.of(content), outcome.state().getContent());
    assertEquals(new AddPostDone(&quot;post-1&quot;), outcome.getReplies().get(0));
    assertEquals(Collections.emptyList(), outcome.issues());
  }

  @Test
  public void testInvalidTitle() {
    PersistentEntityTestDriver&lt;BlogCommand, BlogEvent, BlogState&gt; driver =
        new PersistentEntityTestDriver&lt;&gt;(system, new Post(), &quot;post-1&quot;);

    Outcome&lt;BlogEvent, BlogState&gt; outcome = driver.run(
        new AddPost(new PostContent(&quot;&quot;, &quot;Body&quot;)));
    assertEquals(InvalidCommandException.class,
        outcome.getReplies().get(0).getClass());
    assertEquals(0, outcome.events().size());
    assertEquals(Collections.emptyList(), outcome.issues());
  }

  @Test
  public void testChangeBody() {
    PersistentEntityTestDriver&lt;BlogCommand, BlogEvent, BlogState&gt; driver =
        new PersistentEntityTestDriver&lt;&gt;(system, new Post(), &quot;post-1&quot;);

    driver.run(new AddPost(new PostContent(&quot;Title&quot;, &quot;Body&quot;)));

    Outcome&lt;BlogEvent, BlogState&gt; outcome = driver.run(
      new ChangeBody(&quot;New body 1&quot;),
      new ChangeBody(&quot;New body 2&quot;));

    assertEquals(new BodyChanged(&quot;post-1&quot;, &quot;New body 1&quot;), outcome.events().get(0));
    assertEquals(new BodyChanged(&quot;post-1&quot;, &quot;New body 2&quot;), outcome.events().get(1));
    assertEquals(2, outcome.events().size());
    assertEquals(false, outcome.state().isPublished());
    assertEquals(&quot;New body 2&quot;, outcome.state().getContent().get().getBody());
    assertEquals(Done.getInstance(), outcome.getReplies().get(0));
    assertEquals(Done.getInstance(), outcome.getReplies().get(1));
    assertEquals(2, outcome.getReplies().size());
    assertEquals(Collections.emptyList(), outcome.issues());
  }

}</code></pre>
<p><code>run</code> may be invoked multiple times to divide the sequence of commands into manageable steps. The <a href="api/index.html?com/lightbend/lagom/javadsl/testkit/PersistentEntityTestDriver.Outcome.html">Outcome</a> contains the events and side-effects of the last <code>run</code>, but the state is not reset between different runs.</p>
<p>Note that it also verifies that all commands, events, replies and state are <a href="Serialization.html">serializable</a>, and reports any such problems in the <code>issues</code> of the <code>Outcome</code>.</p>
<p>To use this feature add the following in your project&rsquo;s build.</p>
<p>In Maven:</p>
<pre class="prettyprint"><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.lightbend.lagom&lt;/groupId&gt;
    &lt;artifactId&gt;lagom-javadsl-cluster_2.11&lt;/artifactId&gt;
    &lt;version&gt;${lagom.version}&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>
<p>In sbt:</p>
<pre class="prettyprint"><code class="language-sbt">libraryDependencies += lagomJavadslTestKit</code></pre><h2 id="Full-Example"><a class="section-marker" href="#Full-Example">§</a><a href="#full-example" name="full-example">Full Example</a></h2>
<pre class="prettyprint"><code class="language-java">import com.lightbend.lagom.javadsl.persistence.PersistentEntity;
import java.util.Optional;
import akka.Done;

public class Post extends PersistentEntity&lt;BlogCommand, BlogEvent, BlogState&gt; {

  @Override
  public Behavior initialBehavior(Optional&lt;BlogState&gt; snapshotState) {
    if (snapshotState.isPresent() &amp;&amp; !snapshotState.get().isEmpty()) {
      // behavior after snapshot must be restored by initialBehavior
      return becomePostAdded(snapshotState.get());
    } else {
      // Behavior consist of a State and defined event handlers and command handlers.
      BehaviorBuilder b = newBehaviorBuilder(BlogState.EMPTY);

      // Command handlers are invoked for incoming messages (commands).
      // A command handler must &quot;return&quot; the events to be persisted (if any).
      b.setCommandHandler(AddPost.class, (AddPost cmd, CommandContext&lt;AddPostDone&gt; ctx) -&gt; {
        if (cmd.getContent().getTitle() == null || cmd.getContent().getTitle().equals(&quot;&quot;)) {
          ctx.invalidCommand(&quot;Title must be defined&quot;);
          return ctx.done();
        }

        final PostAdded postAdded =
            new PostAdded(entityId(), cmd.getContent());
        return ctx.thenPersist(postAdded, (PostAdded evt) -&gt;
        // After persist is done additional side effects can be performed
            ctx.reply(new AddPostDone(entityId())));
      });

      // Event handlers are used both when persisting new events and when replaying
      // events.
      b.setEventHandlerChangingBehavior(PostAdded.class, evt -&gt;
        becomePostAdded(new BlogState(Optional.of(evt.getContent()), false)));

      return b.build();
    }
  }

  // Behavior can be changed in the event handlers.
  private Behavior becomePostAdded(BlogState newState) {
    BehaviorBuilder b = newBehaviorBuilder(newState);

    b.setCommandHandler(ChangeBody.class,
        (cmd, ctx) -&gt; ctx.thenPersist(new BodyChanged(entityId(), cmd.getBody()), evt -&gt;
          ctx.reply(Done.getInstance())));

    b.setEventHandler(BodyChanged.class, evt -&gt; state().withBody(evt.getBody()));

    return b.build();
  }

}</code></pre>
<p>You find the classes for the commands, events and state in the <a href="Immutable.html">Immutable Objects</a> section.</p><h2 id="Refactoring-Consideration"><a class="section-marker" href="#Refactoring-Consideration">§</a><a href="#refactoring-consideration" name="refactoring-consideration">Refactoring Consideration</a></h2>
<p>If you change the class name of a <code>PersistentEntity</code> you have to override <code>entityTypeName</code> and retain the original name because this name is part of the key of the store data (it is part of the <code>persistenceId</code> of the underlying <code>PersistentActor</code>). By default the <code>entityTypeName</code> is using the short class name of the concrete <code>PersistentEntity</code> class.</p><h2 id="Configuration"><a class="section-marker" href="#Configuration">§</a><a href="#configuration" name="configuration">Configuration</a></h2>
<p>The default configuration should be good starting point, and the following settings may later be amended to customize the behavior if needed. The following is a listing of the non database specific settings for Lagom persistence:</p>
<pre class="prettyprint"><code class="language-conf">lagom.persistence {

  # As a rule of thumb, the number of shards should be a factor ten greater 
  # than the planned maximum number of cluster nodes. Less shards than number
  # of nodes will result in that some nodes will not host any shards. Too many 
  # shards will result in less efficient management of the shards, e.g. 
  # rebalancing overhead, and increased latency because the coordinator is 
  # involved in the routing of the first message for each shard. The value 
  # must be the same on all nodes in a running cluster. It can be changed 
  # after stopping all nodes in the cluster.
  max-number-of-shards = 100

  # Persistent entities saves snapshots after this number of persistent
  # events. Snapshots are used to reduce recovery times.
  # It may be configured to &quot;off&quot; to disable snapshots.
  snapshot-after = 100
  
  # A persistent entity is passivated automatically if it does not receive 
  # any messages during this timeout. Passivation is performed to reduce
  # memory consumption. Objects referenced by the entity can be garbage
  # collected after passivation. Next message will activate the entity
  # again, which will recover its state from persistent storage.  
  passivate-after-idle-timeout = 120s
  
  # Specifies that entities run on cluster nodes with a specific role.
  # If the role is not specified (or empty) all nodes in the cluster are used.
  # The entities can still be accessed from other nodes.
  run-entities-on-role = &quot;&quot;
  
  # Default timeout for PersistentEntityRef.ask replies.
  ask-timeout = 5s
  
  dispatcher {
    type = Dispatcher
    executor = &quot;thread-pool-executor&quot;
    thread-pool-executor {
      fixed-pool-size = 16
    }
    throughput = 1
  }
}</code></pre><h2 id="Underlying-Implementation"><a class="section-marker" href="#Underlying-Implementation">§</a><a href="#underlying-implementation" name="underlying-implementation">Underlying Implementation</a></h2>
<p>Each <code>PersistentEntity</code> instance is executed by a <a href="http://doc.akka.io/docs/akka/2.4/java/persistence.html">PersistentActor</a> that is managed by <a href="http://doc.akka.io/docs/akka/2.4/java/cluster-sharding.html">Akka Cluster Sharding</a>.</p>
                </article>

                
                    <p class="edit-source">Found an error in this documentation? The source code for this page can be found
                        <a href="https://github.com/lagom/lagom/tree/1.2.x/docs/manual/guide/cluster/PersistentEntity.md">here</a>. Please feel free to edit and contribute a pull request.</p>
                
            </div>
            <aside class="small-12 large-4 columns">
                <nav class="side-menu">

                    <input type="text" id="docs-search" placeholder="Search"/>

                    <label for="docs-version">Version:</label>
                    <select id="docs-version">
                    
                        <option value="/documentation/1.0.x/java/PersistentEntity.html">1.0.x</option>
                    
                        <option value="/documentation/1.1.x/java/PersistentEntity.html">1.1.x</option>
                    
                        <option value="/documentation/1.2.x/java/PersistentEntity.html" selected="selected">1.2.x</option>
                    
                    </select>

                    <a href="/documentation/1.2.x/java/api/index.html" class="api-docs">API Documentation</a>

                    
                        <h3>Writing persistent and clustered services</h3>
                        <ul>
                        
                            
                                <li class="current-page"><a href="PersistentEntity.html">Persistent Entity</a></li>
                            
                        
                            
                                <li><a href="PersistentEntityCassandra.html">Cassandra Persistent Entities</a></li>
                            
                        
                            
                                <li><a href="PersistentEntityRDBMS.html">Relational Database Persistent Entities</a></li>
                            
                        
                            
                                <li><a href="ReadSide.html">Persistent Read-Side</a></li>
                            
                        
                            
                                <li><a href="ReadSideCassandra.html">Cassandra Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="ReadSideRDBMS.html">Relational Database Read-Side Support</a></li>
                            
                        
                            
                                <li><a href="PubSub.html">Publish-Subscribe</a></li>
                            
                        
                            
                                <li><a href="Serialization.html">Serialization</a></li>
                            
                        
                            
                                <li><a href="Cluster.html">Cluster</a></li>
                            
                        
                        </ul>
                    
                        <h3>Lagom reference guide</h3>
                        <ul>
                        
                            
                                <li><a href="ReferenceGuide.html">Reference Guide</a></li>
                            
                        
                            
                                <li><a href="LagomBuild.html">Defining a Lagom build</a></li>
                            
                        
                            
                                <li><a href="DevEnvironment.html">Running Lagom in development</a></li>
                            
                        
                            
                                <li><a href="ServiceDescriptors.html">Writing Lagom services</a></li>
                            
                        
                            
                                <li class="current-page"><a href="PersistentEntity.html">Writing persistent and clustered services</a></li>
                            
                        
                            
                                <li><a href="MessageBroker.html">Decouple services with a message broker</a></li>
                            
                        
                            
                                <li><a href="Overview.html">Running Lagom in production</a></li>
                            
                        
                            
                                <li><a href="Logging.html">Logging</a></li>
                            
                        
                            
                                <li><a href="Akka.html">Advanced topics</a></li>
                            
                        
                        </ul>
                    
                        <h3>Home</h3>
                        <ul>
                        
                            
                                <li><a href="Home.html">Home</a></li>
                            
                        
                            
                                <li><a href="WhatIsLagom.html">Welcome to Lagom</a></li>
                            
                        
                            
                                <li><a href="CoreConcepts.html">Lagom core concepts</a></li>
                            
                        
                            
                                <li><a href="Installation.html">Getting started with Lagom</a></li>
                            
                        
                            
                                <li class="current-page"><a href="ReferenceGuide.html">Lagom reference guide</a></li>
                            
                        
                            
                                <li><a href="ImmutablesInIDEs.html">Appendix</a></li>
                            
                        
                            
                                <li><a href="Migration12.html">Lagom Releases</a></li>
                            
                        
                        </ul>
                    
                </nav>
            </aside>
        </div>
   </div>


                    <footer>
                        <section class="fw-wrapper lb-grey-dkr support">
                            <div class="row">
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-chat" version="1.1" id="Chat" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
	 viewBox="0 0 20 20" style="enable-background:new 0 0 20 20;" xml:space="preserve">
<path fill="#ffffff" d="M5.8,12.2V6H2C0.9,6,0,6.9,0,8v6c0,1.1,0.9,2,2,2h1v3l3-3h5c1.1,0,2-0.9,2-2v-1.82c-0.064,0.014-0.132,0.021-0.2,0.021h-7
	V12.2z M18,1H9C7.9,1,7,1.9,7,3v8h7l3,3v-3h1c1.1,0,2-0.899,2-2V3C20,1.9,19.1,1,18,1z"/>
</svg>

                                    <h3>Community support</h3>
                                    <ul>
                                        <li><a href="//groups.google.com/forum/#!forum/lagom-framework">Mailing list</a></li>
                                        <li><a href="//stackoverflow.com/questions/tagged/lagom">Stackoverflow</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <svg class="svg-icon svg-icon-lb-icon-reverse" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 302 262">
    <title>lightbend-icon</title>
    <path  fill="#ffffff" d="M1,195v56a10,10,0,0,0,10,10H291a10,10,0,0,0,10-10V195a557.85,557.85,0,0,1-150,20A557.85,557.85,0,0,1,1,195Z" />
    <path  fill="#ffffff" d="M291,1H11A10,10,0,0,0,1,11V176a539.94,539.94,0,0,0,150,21,539.94,539.94,0,0,0,150-21V11A10,10,0,0,0,291,1Z" />
</svg>

                                    <h3>Professional support</h3>
                                    <ul>
                                        <li><a href="//www.lightbend.com/services/expert-support">Lightbend Subscription</a></li>
                                        <li><a href="//www.lightbend.com/services/training">Training</a></li>
                                        <li><a href="//www.lightbend.com/services/consulting">Consulting</a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lb-grey links">
                            <div class="row">
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Lagom</h3>
                                    <ul class="no-bullet">
                                        <li><a href="/download.html">Download</a></li>
                                        <li><a href="/blog">Blog</a></li>
                                        <li><a href="/documentation/1.2.x/java/Home.html">Documentation</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Community links</h3>
                                    <ul>
                                        <li><a href="//www.eventbrite.com/directory/?q=lagom&amp;loc=Worldwide">Events <em>via Eventbrite</em></a></li>
                                        <li><a href="http://www.indeed.com/jobs?q=%22lagom%22&amp;l=">Jobs <em>via Indeed</em></a></li>
                                        <li><a href="http://www.scoop.it/lagom">Blogs <em>via Scoop.it</em></a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Code &amp; contribution</h3>
                                    <ul>
                                        <li><a href="//github.com/lagom/lagom/issues">Bug tracker <em>GitHub</em></a></li>
                                        <li><a href="/get-involved.html">Get involved</a></li>
                                    </ul>
                                </div>
                                <div class="small-12 medium-6 large-3 columns">
                                    <h3>Social networks</h3>
                                    <ul>
                                        <li><a href="//twitter.com/lagom"><span>Twitter</span></a></li>
                                    </ul>
                                </div>
                            </div>
                        </section>

                        <section class="fw-wrapper lgm-purple-dkr credits">
                            <div class="row">
                                <div class="small-12 medium-3 columns">
                                    <a href="/" class="logo"><img src="/images/logos/lagom-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-3 columns">
                                    <a href="//lightbend.com" class="partner"><img src="/images/logos/lightbend-reverse.svg"></a>
                                </div>
                                <div class="small-12 medium-6 columns">
                                    <p>Lagom is released under the Apache 2 License</p>
                                </div>
                            </div>
                        </section>

                    </footer>

                </div>
            </div>
        </div>
    </body>
    <script src="/all-scripts-concat.js"></script>

    <script>
  		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  		})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  		ga('create', 'UA-84991267-1', 'auto');
  		ga('send', 'pageview');
	</script>
     
    <script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script>
    <script type="text/javascript"> docsearch({
        apiKey: "77ef1e29e6bddfca861f7a42cc51725e",
        indexName: "lagomframework",
        inputSelector: "#docs-search",
        algoliaOptions: {
            // facetFilters: '["version:1.2.x"]'
        }
    });
    </script>
    

</html>

